pipeline {
    agent {
        docker {
            image 'yosefadel/aws-node'
        }
    }
    environment {
        KVDB_BUCKET = credentials('KVDB_BUCKET')
        AWS_DEFAULT_REGION = "us-east-1"
    }
    stages {
        stage('Save Old Workflow ID') {
            steps {
                script {
                    def oldWorkflowID = sh(
                        script: "aws cloudformation list-exports \
                            --query \"Exports[?Name==\`WorkflowID\`].Value\" \
                            --no-paginate --output text",
                        returnStdout: true
                    ).trim()
                    sh "curl -k https://kvdb.io/${KVDB_BUCKET}/old_workflow_id -d \"${oldWorkflowID}\""
                    echo "Old Workflow ID: ${oldWorkflowID}"
                }
            }
        }
        stage('Update CloudFront Distribution') {
            steps {
                sh "aws cloudformation deploy \
                      --template-file .circleci/files/cloudfront.yml \
                      --parameter-overrides WorkflowID=\"${BUILD_TAG}\" \
                      --stack-name InitialStack"
            }
        }
        stage('Destroy Environment') {
            steps {
                // Code to destroy environment goes here
            }
        }
        stage('Revert Migrations') {
            steps {
                // Code to revert migrations goes here
            }
        }
    }
}
